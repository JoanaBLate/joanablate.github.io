<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Simple Mouse Events Handling</title>
    <meta name="description" content="A simple demo about mouse event handling on a canvas based web page.">
    <meta name="viewport"    content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAB5JREFUOE9jfCbH8J+BAsA4agDDaBgwjIYBw7AIAwBQWyBB+KrPWgAAAABJRU5ErkJggg==">
    <style>       
        body {  
            display: block;
            margin:  0px;  
            padding: 0px;
            overflow: hidden;
            background-color: rgb(78,80,84);
        }
    </style>
</head>
<body>
<script>
"use strict"

// PSEUDO LIBRARY CODE SECTION ////////////////////////////////////////////////
// PSEUDO LIBRARY CODE SECTION ////////////////////////////////////////////////
// PSEUDO LIBRARY CODE SECTION ////////////////////////////////////////////////

// stage //////////////////////////////////////////////////////////////////////

var stage

function initStage(width, height) {
    //
    stage = document.createElement("div")
    stage.display = "inline-block"
    stage.style.position = "fixed"
    stage.style.margin = "0px"
    stage.style.padding = "0px"
    stage.style.top = "0px"
    stage.style.left = "0px"
    stage.style.width = width + "px"
    stage.style.height = height + "px"
    stage.style.zIndex = "-1"
    stage.style.backgroundColor = "lightgrey"
    //
    document.body.appendChild(stage)
    //
    resetStagePosition()
    //
    window.onresize = resetStagePosition
}

function resetStagePosition() {
    //
    let excedent = window.innerWidth - 1300
    if (excedent <= 0) { excedent = 0 }
    //
    const left = Math.floor(excedent / 2)
    stage.style.left = left + "px"    
}

// virtual layers /////////////////////////////////////////////////////////////

const allVirtualLayers = { }

var allVirtualLayersOrder = [ ]  

function VirtualLayer(id) {
    //
    this.id = id
    this.visible = true
    this.panels = [ ]
}

function createVirtualLayer(id) {
    //
    const vl = new VirtualLayer(id)
    Object.seal(vl)
    //
    allVirtualLayers[id] = vl
    allVirtualLayersOrder.push(vl)
    return vl
}

function addPanelToVirtualLayer(panel, vl) {
    //
    vl.panels.push(panel)
    //
    const index = allVirtualLayersOrder.indexOf(vl)
    panel.canvas.style.zIndex = "" + index
    stage.appendChild(panel.canvas)
}

function getAllVirtualLayersOrderIds() {
    //
    const list = [ ]
    for (const vl of allVirtualLayers) { list.push(vl.id) }
    //
    return list
}

function changeAllVirtualLayersOrder(reference) {
    //
    const temp = [ ]
    //
    for (const index of reference) {
        //
        const vl = allVirtualLayersOrder[index]
        temp.push(vl)    
    }
    //
    allVirtualLayersOrder = temp
    updateZIndexOfPanels()
}

function updateZIndexOfPanels() {
    //
    let level = -1
    for (const vl of allVirtualLayersOrder) {
        //
        level += 1
        //
        for (const panel of vl.panels) { panel.canvas.style.zIndex = "" + level }
    }
}

// panel //////////////////////////////////////////////////////////////////////

const allPanels = { }

function Panel(id, width, height) {
    //
    this.id = id
    this.widgets = [ ]
    //
    const cnv = createCanvas(width, height)
    const ctx = cnv.getContext("2d")
    //
    cnv.style.position = "absolute"
    cnv.style.left = "0px"
    cnv.style.top = "0px"
    cnv.style.backgroundColor = "tan"
    //
    cnv.onmouseenter = null
    cnv.onmouseleave = null
    cnv.onmouseup = null
    cnv.onmousedown = function (e) { mouseDownOnPanelById(e, id) }
    cnv.onclick = null
    //    
    this.canvas = cnv
    this.context = ctx
}

function createPanel(id, width, height, bgcolor, left, top) {
    //
    const panel = new Panel(id, width, height)
    Object.seal(panel)
    //
    if (bgcolor) { panel.canvas.style.backgroundColor = bgcolor }
    if (left)    { panel.canvas.style.left = left + "px" }
    if (top)     { panel.canvas.style.top = top + "px" }
    //
    allPanels[id] = panel    
    return panel
}

function paintPanel(panel) {
    //
    const cnv = panel.canvas
    const ctx = panel.context
    //
    ctx.clearRect(0, 0, cnv.width, cnv.height)
    //
    for (const widget of panel.widgets) { 
        ctx.fillStyle = widget.backgroundColor
        ctx.fillRect(widget.left, widget.top, widget.width, widget.height)
    }
}

// panel mouse handler ////////////////////////////////////////////////////////

function mouseDownOnPanelById(e, id) {
    //
    const panel = allPanels[id]
    //
    const x = e.offsetX
    const y = e.offsetY
    //
    const widget = findWidgetUnderMouse(panel, x, y)
    //
    if (widget == null) { return }
    //
    if (widget.onmousedown != null) { widget.onmousedown(widget.left - x, widget.top - y) }
}

function findWidgetUnderMouse(panel, x, y) {
    //
    for (const widget of panel.widgets) {
        //
        if (widget.left > x) { continue }
        if (widget.left + widget.width < x) { continue }
        //
        if (widget.top > y) { continue }
        if (widget.top + widget.height < y) { continue }
        //
        return widget    
    }
    //
    return null
}

// widget /////////////////////////////////////////////////////////////////////

const allWidgets = { }

function addWidgetToPanel(widget, panel) {
    //
    panel.widgets.push(widget)
    paintPanel(panel)
}

// widget - surface ///////////////////////////////////////////////////////////

function Surface(id, width, height) { // NO INNER CANVAS!!!
    //
    this.id = id
    //
    this.left = 0
    this.top = 0
    this.width = width
    this.height = height
    this.backgroundColor = "chocolate"
    //
    this.onmouseenter = null
    this.onmouseleave = null
    this.onmouseup = null
    this.onmousedown = null
    this.onclick = null
}

function createSurface(id, width, height, bgcolor, left, top) {
    //
    const surface = new Surface(id, width, height)
    Object.seal(surface)
    //
    if (bgcolor) { surface.backgroundColor = bgcolor }
    if (left)    { surface.left = left }
    if (top)     { surface.top = top }
    //
    allWidgets[id] = surface    
    return surface
}

// helpers ////////////////////////////////////////////////////////////////////

function createCanvas(width, height) {
    const cnv = document.createElement("canvas")
    cnv.width  = width
    cnv.height = height
    return cnv
}

// DEVELOPER CODE SECTION /////////////////////////////////////////////////////
// DEVELOPER CODE SECTION /////////////////////////////////////////////////////
// DEVELOPER CODE SECTION /////////////////////////////////////////////////////
// 
// >> Missing a proper library 
//
// surface is the simplest kind of widget; it is OK for a simple demo
//

function main() {
    //
    initStage(1300, 660)
    //
    // creating the components
    //
    const america = createVirtualLayer("america")
    const europe = createVirtualLayer("europe")
    //
    //     arguments for creation of panels and widgets
    //     --- mandatory ---  ---- optional ----
    //     id, width, height, bgColor, left, top
    //
    const usa = createPanel("usa", 750, 660)
    const england = createPanel("england", 750, 660, "teal", 1300-750)
    //
    const newyork = createSurface("newyork", 180, 90, null, 160, 120) 
    const miami = createSurface("miami", 180, 90, "seagreen", 160, 300)
    //
    // creating the relationships
    //
    addPanelToVirtualLayer(usa, america)
    addPanelToVirtualLayer(england, europe)
    //
    addWidgetToPanel(newyork, usa)
    addWidgetToPanel(miami, usa)
    //
    // configuring the panels
    // (nothing to do)
    //
    // configuring the widgets
    //
    miami.onmousedown = function () { changeAllVirtualLayersOrder([1, 0]) }
    //
    newyork.onmousedown = function () {
         //
         const n = newyork.backgroundColor
         const m = miami.backgroundColor
        //
        miami.backgroundColor = n
        newyork.backgroundColor = m
        //
        paintPanel(usa)
    }
}

main() 

</script>

</body>
</html>

