<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Test Font Sheet</title>
    <meta name="description" content="A simple tool for testing a font sheet.">
    <meta name="viewport"    content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAB5JREFUOE9jdFs94z8DBYBx1ACG0TBgGA0DhmERBgAd8SiRIkRG+QAAAABJRU5ErkJggg==">
    <style>       
        body {  
            display: block;
            margin:  30px;  
            padding: 0px;
            font-family: sans-serif;
        } 
        #sheet {  
            display: inline-block;
            margin:  0;  
            padding: 0px;
            border: dashed 1px dimgrey;
        }  
        #result {
            padding: 0;
            border: dotted 1px dimgrey;
            background-color: lightseagreen;
        }
    </style>
</head>
<body>
    
    <canvas id="result"></canvas><br><br>

    This simple tool tests a font sheet made with <a href="create-font-sheet.html">Create Font Sheet</a>.<br><br>
    It is extremely important that the font sheet has been perfectly produced:<br>
    - contains (just) everything INSIDE the dashed border<br>
    - the first pixel is not covered by any symbol (including its antialiasing)<br><br>
    
    After you load the font sheet (PNG image), you can type characters (and backspace) and see the result.<br><br>
    
    Always check the first and the last symbol of each row.<br><br>
    
    <a href="https://javascript.plainenglish.io/goodbye-html-hello-canvas-part-1-92f750961666">Goodbye HTML. Hello Canvas!</a> shows how to use this stuff.<br><br><br>

    <canvas id="sheet"></canvas><br><br><br>

    <input type="file" id="load"><br><br>
    
<script>
"use strict"

var myFont = { }

var userText = "Goodbye HTML. Hello Canvas!"

var sheet
var fileSelector
var resultBox

var R = 0
var G = 0
var B = 0
var A = 0

const fontReferenceA = "ABCDEFGHIJKLMNOPQRSTUVWXYZ"
const fontReferenceB = "abcdefghijklmnopqrstuvwxyz"
const fontReferenceC = "0123456789.,:;(){}[]<>"
const fontReferenceD = "?/|\\~^'\"!@#$%&*_-+=" // IMPORTANT: FUNCTION createSpace EXPECTS "." EXISTS!!!!

///////////////////////////////////////////////////////////////////////////////

function main() {
    //
    sheet = document.querySelector("#sheet")
    //
    resultBox = document.querySelector("#result")
    resultBox.width = 900
    resultBox.height = 30
    //
    initFileSelector()
}

// displaying /////////////////////////////////////////////////////////////////

function displayUserText() {
    //
    const ctx = resultBox.getContext("2d")
    ctx.clearRect(0, 0, resultBox.width, resultBox.height)
    //
    const symbols = userText.split("")
    //
    var left = 0
    for (const symbol of symbols) {
        //
        ctx.drawImage(myFont[symbol], left, 0)
        left += myFont[symbol].width    
    }
}

// listening //////////////////////////////////////////////////////////////////

function startListening() {
    //
    document.onkeydown = updateUserText
}

function updateUserText(e) {
    //
    if (e.key == "Backspace") {
        if (userText == "") { return }
        userText = userText.substring(0, userText.length - 1)
        displayUserText()
        return 
    }
    //
    if (myFont[e.key] == undefined  &&  e.key != " ") { return }
    //
    userText += e.key
    //
    if (displayingLength(userText) > resultBox.width - 5) { userText = userText.substring(1) }
    //
    displayUserText()
    //
    return 
}

function displayingLength(text) {
    //
    let len = 0
    const symbols = text.split("")
    //
    for (const symbol of symbols) { len += myFont[symbol].width }
    //
    return len
}

// loading ////////////////////////////////////////////////////////////////////

function initFileSelector() {
    //
    fileSelector = document.querySelector("#load")
    fileSelector.onchange = fileSelectorChanged
}

function fileSelectorChanged() {
    //
    fileSelector.blur() // or else will be activated by spacebar
    //
    const file = fileSelector.files[0]
    //
    if (file == undefined) { console.log("image loading aborted"); return } // should not happen
    //
    console.log("loading:", file.type, "  ", file.name, "  bytes:", file.size)
    //
    const reader = new FileReader()
    reader.onloadend = function (e) { readerEndedLoading(file.name, e.target.result) }
    reader.readAsDataURL(file)
}

function readerEndedLoading(__filename, data) {
    //
    const img = document.createElement("img")
    img.onload = function () { imageLoaded(img) }
    img.src = data
}

function imageLoaded(img) {
    //
    sheet.width = img.width
    sheet.height = img.height
    //
    const ctx = sheet.getContext("2d")
    ctx.clearRect(0, 0, sheet.width, sheet.height)
    ctx.drawImage(img, 0, 0)
    //
    const data = ctx.getImageData(0, 0, 1, 1).data
    R = data[0]
    G = data[1]
    B = data[2]
    A = data[3]
    //
    resultBox.style.backgroundColor = "rgb(" + R + "," + G + "," + B + ")"
    // 
    processSheet()
    displayUserText()
    startListening()
}

// creating the font //////////////////////////////////////////////////////////

function processSheet() { 
    //
    const height = sheet.height / 4
    if (Math.floor(height) != height) { alert("It seems the height of the image is not OK"); return }
    //    
    resultBox.height = height
    //
    processRow(0*height, height, fontReferenceA)
    processRow(1*height, height, fontReferenceB)
    processRow(2*height, height, fontReferenceC)
    processRow(3*height, height, fontReferenceD)
    //
    myFont[" "] = createSpace()
}

function processRow(top, height, fontReference) {
    //
    const width = sheet.width
    //
    const row = document.createElement("canvas")
    row.width = width
    row.height = height
    const ctx = row.getContext("2d")
    ctx.drawImage(sheet, 0, -top)
    //
    const data = ctx.getImageData(0, 0, width, height).data
    //
    const symbols = fontReference.split("")
    //
    createSymbolsFromRow(row, data, height, symbols)
}

function createSymbolsFromRow(row, data, height, symbols) {
    //
    let left = -1
    //
    for (const symbol of symbols) {
        //
        // finding the start of the symbol
        //
        while (true) {
            //
            left += 1
            if (left >= sheet.width) { return }
            //
            if (! isBlankCol(data, height, left)) { break }
        }
        const start = left
        //
        // finding the end of the symbol 
        //
        while (true) {
            //
            left += 1
            if (isBlankCol(data, height, left)) { break }
        }
        //
        const width = left - start
        //
        const cnv = document.createElement("canvas")
        cnv.width = width
        cnv.height = height
        cnv.getContext("2d").drawImage(row, -start, 0)
        //
        myFont[symbol] = cnv
    }
}

function isBlankCol(data, height, x) {
    //
    if (x >= sheet.width) { return true } // out of canvas
    //
    for (let y = 0; y < height; y++) {
        const index = 4 * (sheet.width * y + x)
        if (data[index]     != R) { return false }
        if (data[index + 1] != G) { return false }
        if (data[index + 2] != B) { return false }
        if (data[index + 3] != A) { return false }
    }
    return true
} 

function createSpace() {
    //
    const reference = myFont["."]
    //
    const cnv = document.createElement("canvas")
    cnv.width = reference.width
    cnv.height = reference.height
    const ctx = cnv.getContext("2d")
    //
    ctx.fillStyle = `rgba(${R},${G},${B},${A})`
    ctx.fillRect(0, 0, cnv.width, cnv.height)
    //
    return cnv
}

///////////////////////////////////////////////////////////////////////////////

main() 

</script>

</body>
</html>

